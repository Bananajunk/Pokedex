<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Living Pokédex</title>
    
    <!-- SEO & Social Sharing -->
    <meta name="description" content="A Living Pokédex with AI Voice Search and Evolution Paths.">
    <meta property="og:title" content="Living Pokédex">
    <meta property="og:description" content="Interactive Pokédex with voice search powered by Gemini.">
    <meta property="og:type" content="website">
    
    <!-- Mobile Web App Settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Pokédex">

    <!-- App Icons -->
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png">
    <link rel="apple-touch-icon" href="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png">

    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        
        /* Card hover effect */
        .poke-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .poke-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }

        /* Loading spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ef4444;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Animations */
        .ai-listening { animation: pulse-blue 1.5s infinite; background-color: #3b82f6 !important; border-color: #60a5fa !important; }
        .ai-processing { animation: pulse-purple 1.5s infinite; background-color: #9333ea !important; }
        .browser-listening { animation: pulse-red 1.5s infinite; background-color: #ef4444 !important; }

        @keyframes pulse-blue { 0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(59, 130, 246, 0); } 100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); } }
        @keyframes pulse-purple { 0% { box-shadow: 0 0 0 0 rgba(147, 51, 234, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(147, 51, 234, 0); } 100% { box-shadow: 0 0 0 0 rgba(147, 51, 234, 0); } }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

        /* Tooltip styling */
        .fab-container:hover .fab-tooltip { opacity: 1; transform: translateX(0); }
        
        /* Badges & Tags */
        .game-tag, .info-badge { 
            font-size: 0.6rem; 
            text-transform: uppercase; 
            font-weight: 700; 
            letter-spacing: 0.025em; 
            padding: 0.15rem 0.4rem; 
            border-radius: 4px; 
            box-shadow: 0 1px 1px rgba(0,0,0,0.05); 
            white-space: nowrap; 
        }
        .game-tag { border: 1px solid rgba(0,0,0,0.05); margin-right: 0.25rem; margin-bottom: 0.25rem; display: inline-block;}

        /* Unified Info Badge Style (Used for Roles & Weakness Types) */
        .info-badge {
            color: white; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.2); 
        }
        .info-badge-neutral {
            color: #4b5563; /* gray-600 */
            text-shadow: none;
            background-color: #f3f4f6; /* gray-100 */
            border: 1px solid #e5e7eb; /* gray-200 */
        }

        /* Game Tag Specific Colors */
        .tag-red { background: #fee2e2; color: #991b1b; }
        .tag-blue { background: #dbeafe; color: #1e40af; }
        .tag-yellow { background: #fef9c3; color: #854d0e; }
        .tag-gold { background: #ffedd5; color: #9a3412; }
        .tag-silver { background: #f3f4f6; color: #374151; }
        .tag-crystal { background: #e0f2fe; color: #0369a1; }
        .tag-ruby { background: #ffe4e6; color: #be123c; }
        .tag-sapphire { background: #bfdbfe; color: #1d4ed8; }
        .tag-emerald { background: #d1fae5; color: #047857; }
        .tag-diamond { background: #e0f2fe; color: #0284c7; }
        .tag-pearl { background: #fae8ff; color: #a21caf; }
        .tag-platinum { background: #f3f4f6; color: #4b5563; }
        .tag-black { background: #f3f4f6; color: #111827; }
        .tag-white { background: #ffffff; color: #6b7280; border: 1px solid #e5e7eb; }
        .tag-x { background: #e0e7ff; color: #3730a3; }
        .tag-y { background: #fce7f3; color: #9d174d; }
        .tag-sun { background: #ffedd5; color: #c2410c; }
        .tag-moon { background: #e0f2fe; color: #0f766e; }
        .tag-sword { background: #dbeafe; color: #1d4ed8; }
        .tag-shield { background: #fee2e2; color: #b91c1c; }
        .tag-legends-arceus { background: #fef3c7; color: #92400e; }
        .tag-scarlet { background: #fff1f2; color: #e11d48; border-color: #fda4af; }
        .tag-violet { background: #f5f3ff; color: #7c3aed; border-color: #c4b5fd; }
        .tag-default { background: #f3f4f6; color: #4b5563; }

        /* Type Colors */
        .type-pill { padding: 3px 10px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        
        .type-normal { background-color: #A8A77A; }
        .type-fire { background-color: #EE8130; }
        .type-water { background-color: #6390F0; }
        .type-electric { background-color: #F7D02C; }
        .type-grass { background-color: #7AC74C; }
        .type-ice { background-color: #96D9D6; }
        .type-fighting { background-color: #C22E28; }
        .type-poison { background-color: #A33EA1; }
        .type-ground { background-color: #E2BF65; }
        .type-flying { background-color: #A98FF3; }
        .type-psychic { background-color: #F95587; }
        .type-bug { background-color: #A6B91A; }
        .type-rock { background-color: #B6A136; }
        .type-ghost { background-color: #735797; }
        .type-dragon { background-color: #6F35FC; }
        .type-dark { background-color: #705746; }
        .type-steel { background-color: #B7B7CE; }
        .type-fairy { background-color: #D685AD; }

        /* Stats Bar Colors */
        .stat-bar-hp { background-color: #22c55e; } 
        .stat-bar-atk { background-color: #ef4444; } 
        .stat-bar-def { background-color: #3b82f6; } 
        .stat-bar-spa { background-color: #991b1b; } 
        .stat-bar-spd { background-color: #1e40af; } 
        .stat-bar-spe { background-color: #f97316; } 

    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans flex flex-col relative">

    <!-- Header -->
    <header class="bg-red-600 text-white sticky top-0 z-40 shadow-md">
        <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            
            <!-- Logo area -->
            <div class="flex items-center justify-between w-full md:w-auto">
                <div class="flex items-center gap-2 cursor-pointer select-none" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">
                    <svg class="w-8 h-8 text-white" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 2a8 8 0 0 1 7.93 7h-4.09a4 4 0 0 0-7.68 0H4.07A8 8 0 0 1 12 4zm0 16a8 8 0 0 1-7.93-7h4.09a4 4 0 0 0 7.68 0h4.07A8 8 0 0 1 12 20z"/>
                        <circle cx="12" cy="12" r="2"/>
                    </svg>
                    <h1 class="text-2xl font-bold tracking-tight">Living Pokédex</h1>
                </div>
                
                <!-- Settings Cog (Mobile) -->
                <button onclick="toggleSettings()" class="md:hidden text-white opacity-80 hover:opacity-100 p-2">
                    <i class="ph ph-gear text-2xl"></i>
                </button>
            </div>

            <!-- Controls -->
            <div class="flex flex-col sm:flex-row w-full md:w-auto gap-3 items-center">
                
                <!-- Search Bar -->
                <div class="relative w-full sm:w-72">
                    <input type="text" id="searchInput" placeholder="Search name or number..." class="w-full px-4 py-2 rounded-full text-gray-800 border-none focus:ring-2 focus:ring-blue-400 focus:outline-none shadow-sm">
                </div>

                <div class="flex w-full sm:w-auto gap-2 items-center">
                    <select id="genFilter" class="flex-1 sm:w-48 px-4 py-2 rounded-full text-gray-800 border-none focus:ring-2 focus:ring-blue-400 focus:outline-none cursor-pointer shadow-sm">
                        <option value="all">All Generations</option>
                        <option value="1">Gen 1 (Kanto)</option>
                        <option value="2">Gen 2 (Johto)</option>
                        <option value="3">Gen 3 (Hoenn)</option>
                        <option value="4">Gen 4 (Sinnoh)</option>
                        <option value="5">Gen 5 (Unova)</option>
                        <option value="6">Gen 6 (Kalos)</option>
                        <option value="7">Gen 7 (Alola)</option>
                        <option value="8">Gen 8 (Galar)</option>
                        <option value="9">Gen 9 (Paldea)</option>
                    </select>
                    
                    <button id="clearBtn" class="bg-red-700 hover:bg-red-800 text-white px-4 py-2 rounded-full text-sm font-semibold transition-colors shadow-sm" title="Clear Filters">
                        Clear
                    </button>

                    <!-- Settings Cog (Desktop) -->
                    <button onclick="toggleSettings()" class="hidden md:block text-white opacity-80 hover:opacity-100 ml-1">
                        <i class="ph ph-gear text-2xl"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Stats Bar -->
    <div class="bg-white shadow-sm border-b">
        <div class="container mx-auto px-4 py-2 text-sm text-gray-500 flex justify-between items-center">
            <span id="countDisplay">Loading Pokémon...</span>
            <div id="statusMsg" onclick="showFullError()" class="text-xs text-gray-500 font-medium italic transition-all duration-200 cursor-pointer">Data: PokeAPI</div>
        </div>
    </div>

    <!-- Main Grid -->
    <main class="container mx-auto px-4 py-6 flex-grow">
        <div id="loading" class="flex flex-col justify-center items-center py-20">
            <div class="spinner mb-4"></div>
            <p class="text-gray-500 text-lg">Catching them all...</p>
        </div>

        <div id="pokedexGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 sm:gap-6 hidden"></div>
        
        <div id="noResults" class="hidden text-center py-20">
            <p class="text-xl text-gray-500">No Pokémon found.</p>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-100 py-6 border-t border-gray-200 mt-auto pb-32">
        <div class="container mx-auto px-4 text-center text-gray-400 text-xs">
            <p>&copy; 2025 Living Pokédex. Data via <a href="https://pokeapi.co/" target="_blank" class="underline hover:text-gray-600">PokeAPI</a>.</p>
            <p class="mt-1">Pokémon images & names &copy; Nintendo/Game Freak.</p>
        </div>
    </footer>

    <!-- FAB Container -->
    <div class="fixed bottom-6 right-6 z-[90] flex flex-col gap-4 items-end">
        
        <!-- Camera FAB -->
        <div class="fab-container relative flex items-center">
            <div id="cameraTooltip" class="fab-tooltip absolute right-full mr-3 bg-gray-800 text-white text-xs py-1 px-2 rounded opacity-0 transition-opacity duration-200 whitespace-nowrap pointer-events-none">
                Setup AI Key first
            </div>
            <button id="fabCamera" class="w-14 h-14 bg-blue-500 text-white rounded-full shadow-lg flex items-center justify-center transition-all hover:bg-blue-600 active:scale-95 focus:outline-none disabled:bg-gray-400 disabled:cursor-not-allowed" title="Identify Pokémon">
                <i class="ph ph-camera text-2xl"></i>
            </button>
            <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden">
        </div>

        <!-- Mic FAB -->
        <button id="fabMic" class="w-16 h-16 bg-red-600 text-white rounded-full shadow-lg flex items-center justify-center transition-all hover:bg-red-700 active:scale-95 focus:outline-none" title="Speak to Search">
            <i class="ph ph-microphone text-3xl"></i>
        </button>
    </div>

    <!-- Pokemon Detail Modal -->
    <div id="modal" class="fixed inset-0 bg-black bg-opacity-80 hidden z-[100] flex justify-center items-center p-4 backdrop-blur-sm transition-opacity duration-300 overflow-hidden">
        <div class="bg-white rounded-2xl shadow-2xl max-w-xl w-full max-h-[90vh] flex flex-col relative overflow-hidden" id="modalContent">
            
            <button id="closeModal" class="absolute top-2 right-2 z-30 text-gray-400 hover:text-gray-800 bg-white/50 hover:bg-white rounded-full p-1 opacity-70 hover:opacity-100 transition-all">
                <i class="ph ph-x text-xl"></i>
            </button>

            <!-- Scrollable Content Area -->
            <div class="overflow-y-auto flex-1 h-full p-4">
                
                <!-- TOP GRID: Identity & Combat (2 Columns) -->
                <div class="grid grid-cols-[140px_1fr] gap-4 mb-4">
                    
                    <!-- Left Column: Identity -->
                    <div class="flex flex-col items-center">
                        <!-- Image -->
                        <div class="relative w-32 h-32 flex items-center justify-center mb-1">
                             <img id="modalImg" src="" alt="Pokemon" class="w-full h-full object-contain filter drop-shadow-md">
                        </div>
                        
                        <!-- Name & Details -->
                        <h2 id="modalName" class="text-lg font-extrabold text-gray-800 capitalize leading-none text-center mb-1"></h2>
                        
                        <div class="flex items-center gap-1 mb-2">
                            <span id="modalId" class="text-[10px] font-mono text-gray-400 font-bold"></span>
                            <span class="px-1.5 py-0.5 bg-gray-100 text-gray-500 text-[9px] rounded font-bold uppercase border border-gray-200">Gen <span id="modalGen"></span></span>
                        </div>
                        
                        <!-- Types -->
                        <div id="modalTypes" class="flex flex-wrap justify-center gap-1 w-full"></div>
                    </div>

                    <!-- Right Column: Combat Info -->
                    <div class="flex flex-col pt-1 min-w-0">
                        
                        <!-- Weaknesses -->
                        <div class="mb-3">
                            <h3 class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-1 border-b border-gray-100 pb-0.5">Weakness</h3>
                            <div id="weaknessContainer" class="flex flex-col gap-1"></div>
                        </div>

                        <!-- Battle Role -->
                        <div class="mb-3">
                             <h3 class="text-[9px] font-bold text-gray-400 uppercase tracking-widest mb-1 border-b border-gray-100 pb-0.5">Role</h3>
                             <div id="roleContainer" class="flex flex-wrap gap-1"></div>
                        </div>

                         <!-- Stats Toggle -->
                         <div>
                            <button id="statsToggleBtn" class="w-full flex items-center justify-between text-[10px] font-bold text-gray-400 uppercase tracking-widest bg-gray-50 hover:bg-gray-100 px-3 py-1.5 rounded-md transition-colors border border-gray-100" onclick="toggleStats()">
                                <span>Base Stats</span>
                                <i id="statsToggleIcon" class="ph ph-caret-down text-base"></i>
                            </button>
                            <div id="modalStats" class="hidden grid grid-cols-2 gap-x-4 gap-y-2 text-xs text-gray-600 bg-gray-50 p-2 rounded-b-md border-x border-b border-gray-100 shadow-inner"></div>
                        </div>

                    </div>
                </div>
                
                <hr class="border-gray-100 mb-4">

                <!-- Evolution Section -->
                <div class="mb-4">
                    <h3 class="text-center text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">Evolution Path</h3>
                    <div id="evoLoading" class="hidden py-2 text-center">
                        <div class="spinner mx-auto w-6 h-6 border-2"></div>
                    </div>
                    <div id="evoContainer" class="flex flex-row flex-wrap items-center justify-center gap-1 min-h-[60px]"></div>
                </div>
                
                <hr class="border-gray-100 mb-4">

                <!-- Appearances Section -->
                <div class="mb-4">
                    <h3 class="text-center text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">Appearances</h3>
                    <div id="gamesContainer" class="flex flex-wrap justify-center gap-1 text-[10px]">
                        <span class="italic text-gray-400">Loading...</span>
                    </div>
                </div>

                <div class="text-center">
                     <a id="wikiLink" href="#" target="_blank" class="text-blue-500 hover:text-blue-700 font-semibold text-xs hover:underline flex items-center justify-center gap-1">
                        View on Bulbapedia <i class="ph ph-arrow-square-out"></i>
                    </a>
                </div>

            </div>
        </div>
    </div>

    <!-- Error Detail Modal -->
    <div id="errorModal" class="fixed inset-0 bg-black bg-opacity-80 hidden z-[110] flex justify-center items-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl max-w-sm w-full p-6 text-center">
            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="ph ph-warning-circle text-2xl text-red-600"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-800 mb-2">Error Details</h3>
            <div id="errorDetailText" class="text-sm text-left bg-gray-100 p-3 rounded font-mono overflow-x-auto whitespace-pre-wrap max-h-48 overflow-y-auto mb-4 border border-gray-200">
                No error details available.
            </div>
            <button onclick="document.getElementById('errorModal').classList.add('hidden')" class="w-full px-4 py-2 bg-gray-800 text-white rounded hover:bg-gray-900">Close</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-80 hidden z-[110] flex justify-center items-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="ph ph-gear text-gray-600 text-2xl"></i>
                Voice Search Settings
            </h2>
            
            <!-- Instructions -->
            <div class="mb-6 p-4 bg-blue-50 border border-blue-100 rounded-lg text-sm text-blue-800">
                <p class="font-bold mb-2">How to get a Free API Key:</p>
                <ol class="list-decimal ml-4 space-y-1">
                    <li>Go to <a href="https://aistudio.google.com/app/apikey" target="_blank" class="underline font-bold hover:text-blue-900">Google AI Studio</a>.</li>
                    <li>Click <b>"Get API Key"</b>.</li>
                    <li>Click <b>"Create API key in new project"</b>.</li>
                    <li>Copy the key and paste it below.</li>
                </ol>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-semibold text-gray-700 mb-1">API Key</label>
                <input type="password" id="apiKeyInput" placeholder="Paste your key here (AIzaSy...)" class="w-full px-4 py-2 rounded border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:outline-none mb-3">
                
                <div class="flex justify-between items-center mb-1">
                    <label class="block text-sm font-semibold text-gray-700">AI Model</label>
                    <button onclick="fetchAvailableModels()" id="fetchModelsBtn" class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200 font-semibold">Load Available Models</button>
                </div>
                
                <select id="modelSelect" class="w-full px-4 py-2 rounded border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:outline-none bg-white">
                    <option value="gemini-1.5-flash-latest">Gemini 1.5 Flash Latest</option>
                    <option value="gemini-2.0-flash-exp">Gemini 2.0 Flash (Exp)</option>
                    <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                </select>
                <div id="fetchStatus" class="text-xs text-gray-500 mt-1 h-4"></div>
            </div>

            <div class="flex justify-between items-center gap-3">
                 <button onclick="resetKey()" class="text-xs text-red-500 underline hover:text-red-700">Reset Key</button>
                 <div class="flex gap-2">
                    <button onclick="toggleSettings()" class="px-4 py-2 text-gray-600 hover:text-gray-800">Close</button>
                    <button onclick="saveSettings()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Save</button>
                 </div>
            </div>
            
            <div class="mt-4 border-t border-gray-100 pt-2 text-center">
                <p class="text-[10px] text-gray-400">Powered by Google Gemini</p>
            </div>
        </div>
    </div>

    <script>
        // --- Constants & State ---
        const API_URL = `https://pokeapi.co/api/v2/pokemon?limit=10000`;
        const MAX_STANDARD_ID = 1025; 
        
        const GENERATIONS = {
            1: { start: 1, end: 151 },
            2: { start: 152, end: 251 },
            3: { start: 252, end: 386 },
            4: { start: 387, end: 493 },
            5: { start: 494, end: 649 },
            6: { start: 650, end: 721 },
            7: { start: 722, end: 809 },
            8: { start: 810, end: 905 },
            9: { start: 906, end: 1025 }
        };

        const REGIONAL_EVOLUTIONS = {
            'perrserker': 'Galarian',
            'runerigus': 'Galarian',
            'sirfetchd': 'Galarian',
            'cursola': 'Galarian',
            'obstagoon': 'Galarian',
            'mr-rime': 'Galarian',
            'overqwil': 'Hisuian',
            'sneasler': 'Hisuian',
            'wyrdeer': 'Hisuian',
            'kleavor': 'Hisuian',
            'ursaluna': 'Hisuian',
            'basculegion': 'Hisuian',
            'clodsire': 'Paldean',
            'annihilape': 'Paldean',
            'dudunsparce': 'Paldean',
            'farigiraf': 'Paldean',
            'kingambit': 'Paldean',
            'toedscruel': 'Paldean',
            'wugtrio': 'Paldean',
            'dipplin': 'Applin',
            'hydrapple': 'Applin'
        };
        
        const GAME_REGIONS = {
            'red': 'Kanto', 'blue': 'Kanto', 'yellow': 'Kanto', 'fire-red': 'Kanto', 'leaf-green': 'Kanto', 'lets-go-pikachu': 'Kanto', 'lets-go-eevee': 'Kanto',
            'gold': 'Johto', 'silver': 'Johto', 'crystal': 'Johto', 'heart-gold': 'Johto', 'soul-silver': 'Johto',
            'ruby': 'Hoenn', 'sapphire': 'Hoenn', 'emerald': 'Hoenn', 'omega-ruby': 'Hoenn', 'alpha-sapphire': 'Hoenn',
            'diamond': 'Sinnoh', 'pearl': 'Sinnoh', 'platinum': 'Sinnoh', 'brilliant-diamond': 'Sinnoh', 'shining-pearl': 'Sinnoh', 'legends-arceus': 'Hisui',
            'black': 'Unova', 'white': 'Unova', 'black-2': 'Unova', 'white-2': 'Unova',
            'x': 'Kalos', 'y': 'Kalos',
            'sun': 'Alola', 'moon': 'Alola', 'ultra-sun': 'Alola', 'ultra-moon': 'Alola',
            'sword': 'Galar', 'shield': 'Galar',
            'scarlet': 'Paldea', 'violet': 'Paldea'
        };

        const STANDARD_EVOLUTIONS_TO_BLOCK_IF_REGIONAL = [
            'persian', 'cofagrigus', 'raichu', 'marowak', 'exeggutor', 'weezing', 'linoone'
        ];

        const TYPE_NAMES = [
            'normal', 'fire', 'water', 'electric', 'grass', 'ice', 
            'fighting', 'poison', 'ground', 'flying', 'psychic', 
            'bug', 'rock', 'ghost', 'dragon', 'steel', 'dark', 'fairy'
        ];

        const TYPE_CHART = [
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0.5, 0, 1, 0.5, 1, 1], // Normal
            [1, 0.5, 0.5, 1, 2, 2, 1, 1, 1, 1, 1, 2, 0.5, 1, 0.5, 2, 1, 1], // Fire
            [1, 2, 0.5, 1, 0.5, 1, 1, 1, 2, 1, 1, 1, 2, 1, 0.5, 1, 1, 1], // Water
            [1, 1, 2, 0.5, 0.5, 1, 1, 1, 0, 2, 1, 1, 1, 1, 0.5, 1, 1, 1], // Electric
            [1, 0.5, 2, 1, 0.5, 1, 1, 0.5, 2, 0.5, 1, 0.5, 2, 1, 0.5, 0.5, 1, 1], // Grass
            [1, 0.5, 0.5, 1, 2, 0.5, 1, 1, 2, 2, 1, 1, 1, 1, 2, 0.5, 1, 1], // Ice
            [2, 1, 1, 1, 1, 2, 1, 0.5, 1, 0.5, 0.5, 0.5, 2, 0, 1, 2, 2, 0.5], // Fighting
            [1, 1, 1, 1, 2, 1, 1, 0.5, 0.5, 1, 1, 1, 0.5, 0.5, 1, 0, 1, 2], // Poison
            [1, 2, 1, 2, 0.5, 1, 1, 2, 1, 0, 1, 0.5, 2, 1, 1, 2, 1, 1], // Ground
            [1, 1, 1, 0.5, 2, 1, 2, 1, 1, 1, 1, 2, 0.5, 1, 1, 0.5, 1, 1], // Flying
            [1, 1, 1, 1, 1, 1, 2, 2, 1, 1, 0.5, 1, 1, 1, 1, 0.5, 0, 1], // Psychic
            [1, 0.5, 1, 1, 2, 1, 0.5, 0.5, 1, 0.5, 2, 1, 1, 0.5, 1, 0.5, 2, 0.5], // Bug
            [1, 2, 1, 1, 1, 2, 0.5, 1, 0.5, 2, 1, 2, 1, 1, 1, 0.5, 1, 1], // Rock
            [0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 1, 1, 2, 1, 1, 0.5, 1], // Ghost
            [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 0.5, 1, 0], // Dragon
            [1, 0.5, 0.5, 0.5, 1, 2, 1, 1, 1, 1, 1, 1, 2, 1, 1, 0.5, 1, 2], // Steel
            [1, 1, 1, 1, 1, 1, 0.5, 1, 1, 1, 2, 1, 1, 2, 1, 1, 0.5, 0.5], // Dark
            [1, 0.5, 1, 1, 1, 1, 2, 0.5, 1, 1, 1, 1, 1, 1, 2, 0.5, 2, 1]  // Fairy
        ];

        let allPokemon = [];
        let browserRecognition; 
        let mediaRecorder;
        let audioChunks = [];
        let GEMINI_API_KEY = localStorage.getItem('gemini_api_key') || "";
        let GEMINI_MODEL = localStorage.getItem('gemini_model') || "gemini-1.5-flash-latest";
        let lastErrorDetail = "";

        const grid = document.getElementById('pokedexGrid');
        const loading = document.getElementById('loading');
        const countDisplay = document.getElementById('countDisplay');
        const genFilter = document.getElementById('genFilter');
        const searchInput = document.getElementById('searchInput');
        const clearBtn = document.getElementById('clearBtn');
        const fabMic = document.getElementById('fabMic');
        const fabCamera = document.getElementById('fabCamera');
        const cameraTooltip = document.getElementById('cameraTooltip');
        const cameraInput = document.getElementById('cameraInput');
        
        const statusMsg = document.getElementById('statusMsg');
        const noResults = document.getElementById('noResults');
        const modal = document.getElementById('modal');
        const modalContent = document.getElementById('modalContent');
        const closeModal = document.getElementById('closeModal');
        const evoContainer = document.getElementById('evoContainer');
        const evoLoading = document.getElementById('evoLoading');
        const gamesContainer = document.getElementById('gamesContainer');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const modelSelect = document.getElementById('modelSelect');
        const errorModal = document.getElementById('errorModal');
        const errorDetailText = document.getElementById('errorDetailText');
        const fetchStatus = document.getElementById('fetchStatus');
        const modalTypes = document.getElementById('modalTypes');
        const weaknessContainer = document.getElementById('weaknessContainer');
        const modalStats = document.getElementById('modalStats');
        const roleContainer = document.getElementById('roleContainer');
        const statsToggleBtn = document.getElementById('statsToggleBtn');

        init();
        updateFabStates();
        apiKeyInput.value = GEMINI_API_KEY; 
        modelSelect.value = GEMINI_MODEL;

        statusMsg.addEventListener('click', showFullError);

        async function init() {
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                
                allPokemon = data.results
                    .map((p) => {
                        const id = parseInt(p.url.split('/')[6]);
                        return { 
                            name: p.name, 
                            id: id,
                            url: p.url
                        };
                    })
                    .filter(p => {
                        if (p.id <= MAX_STANDARD_ID) return true;
                        const n = p.name;
                        return n.includes('-alola') || n.includes('-galar') || n.includes('-hisui') || n.includes('-paldea');
                    })
                    .map(p => {
                        const clean = cleanName(p.name);
                        const formatted = formatName(clean); 
                        
                        let gen = 9; 
                        if (p.id <= MAX_STANDARD_ID) {
                            gen = getGeneration(p.id);
                        } else {
                            if (p.name.includes('-alola')) gen = 7;
                            else if (p.name.includes('-galar') || p.name.includes('-hisui')) gen = 8;
                            else if (p.name.includes('-paldea')) gen = 9;
                        }

                        return {
                            id: p.id,
                            name: clean, 
                            displayName: formatted, 
                            image: `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${p.id}.png`,
                            generation: gen,
                            displayId: p.id <= MAX_STANDARD_ID ? formatId(p.id) : 'VAR'
                        };
                    });

                renderPokemon(allPokemon);
                loading.classList.add('hidden');
                grid.classList.remove('hidden');
            } catch (error) {
                console.error("Failed to fetch Pokemon:", error);
                loading.innerHTML = `<p class="text-red-500">Error loading data.</p>`;
            }
        }

        function cleanName(name) {
            if (name.includes('-alola')) return 'Alolan ' + name.replace('-alola', '');
            if (name.includes('-galar')) return 'Galarian ' + name.replace('-galar', '');
            if (name.includes('-hisui')) return 'Hisuian ' + name.replace('-hisui', '');
            if (name.includes('-paldea')) {
                if(name.includes('combat')) return 'Paldean Tauros (Combat)';
                if(name.includes('blaze')) return 'Paldean Tauros (Blaze)';
                if(name.includes('aqua')) return 'Paldean Tauros (Aqua)';
                return 'Paldean ' + name.replace('-paldea', '');
            }

            const suffixesToRemove = [
                '-normal', '-attack', '-defense', '-speed', '-plant', '-sandy', '-trash',
                '-overcast', '-east', '-west', '-standard', '-incarnate', '-therian',
                '-ordinary', '-resolute', '-aria', '-pirouette', '-shield', '-blade',
                '-male', '-female', '-average', '-small', '-large', '-super', '-bound',
                '-unbound', '-meteor', '-red-striped', '-busted', '-disguised',
                '-battle-bond', '-school', '-mask', '-10', '-50', '-complete',
                '-single-strike', '-rapid-strike', '-ice', '-noice', '-full-belly', '-hangry'
            ];

            let cleaned = name;
            
            if (name === 'ho-oh' || name === 'porygon-z' || name === 'type-null' || name.startsWith('jangmo') || name.startsWith('hakamo') || name.startsWith('kommo') || name.startsWith('tapu') || name.startsWith('iron') || name.startsWith('scream') || name.startsWith('flutter') || name.startsWith('great') || name.startsWith('brute') || name.startsWith('sandy') || name.startsWith('slither') || name.startsWith('walking') || name.startsWith('raging') || name.startsWith('gouging') || name.startsWith('roaring')) {
                return name; 
            }

            for (const suffix of suffixesToRemove) {
                if (cleaned.endsWith(suffix)) {
                    cleaned = cleaned.substring(0, cleaned.length - suffix.length);
                    break; 
                }
            }
            return cleaned;
        }

        function calculateWeaknesses(types) {
            const multipliers = {};
            TYPE_NAMES.forEach(t => multipliers[t] = 1);

            types.forEach(t => {
                const defIndex = TYPE_NAMES.indexOf(t.type.name);
                if (defIndex === -1) return;
                TYPE_NAMES.forEach((atkType, atkIndex) => {
                    const mult = TYPE_CHART[atkIndex][defIndex];
                    multipliers[atkType] *= mult;
                });
            });

            const weak2x = [];
            const weak4x = [];

            for (const [type, mult] of Object.entries(multipliers)) {
                if (mult === 2) weak2x.push(type);
                if (mult === 4) weak4x.push(type);
            }

            return { weak2x, weak4x };
        }

        // --- Settings Logic ---
        function toggleSettings() {
            const el = document.getElementById('settingsModal');
            el.classList.toggle('hidden');
            fetchStatus.textContent = "";
        }

        function updateFabStates() {
            if (GEMINI_API_KEY) {
                fabCamera.classList.remove('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                fabCamera.classList.add('bg-blue-500', 'hover:bg-blue-600', 'active:scale-95');
                fabCamera.disabled = false;
                cameraTooltip.classList.add('hidden'); 
            } else {
                fabCamera.classList.add('opacity-50', 'cursor-not-allowed', 'bg-gray-400');
                fabCamera.classList.remove('bg-blue-500', 'hover:bg-blue-600', 'active:scale-95');
                fabCamera.disabled = false; 
                cameraTooltip.classList.remove('hidden');
            }
        }

        async function fetchAvailableModels() {
            const key = apiKeyInput.value.trim();
            if (!key) {
                fetchStatus.textContent = "Please enter API Key first.";
                fetchStatus.className = "text-xs text-red-500 font-bold";
                return;
            }

            fetchStatus.textContent = "Fetching models...";
            fetchStatus.className = "text-xs text-blue-500 animate-pulse";

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models?key=${key}`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.error) {
                    fetchStatus.textContent = "Error: " + data.error.message;
                    fetchStatus.className = "text-xs text-red-500";
                    return;
                }

                if (data.models) {
                    modelSelect.innerHTML = ""; 
                    let count = 0;
                    data.models.sort((a, b) => b.name.localeCompare(a.name));

                    data.models.forEach(model => {
                        if (model.supportedGenerationMethods && model.supportedGenerationMethods.includes("generateContent")) {
                            const value = model.name.replace("models/", "");
                            const opt = document.createElement('option');
                            opt.value = value;
                            opt.textContent = model.displayName || value;
                            modelSelect.appendChild(opt);
                            count++;
                        }
                    });
                    
                    fetchStatus.textContent = `Success! Found ${count} models.`;
                    fetchStatus.className = "text-xs text-green-600 font-bold";
                    
                    if (GEMINI_MODEL) {
                        modelSelect.value = GEMINI_MODEL;
                    }
                } else {
                    fetchStatus.textContent = "No models found for this key.";
                    fetchStatus.className = "text-xs text-orange-500";
                }

            } catch (e) {
                fetchStatus.textContent = "Network Error.";
                fetchStatus.className = "text-xs text-red-500";
            }
        }

        function saveSettings() {
            const key = apiKeyInput.value.trim();
            const model = modelSelect.value;
            
            if (!key) {
                alert("Please enter a key or click Reset.");
                return;
            }
            
            localStorage.setItem('gemini_api_key', key);
            localStorage.setItem('gemini_model', model);
            
            GEMINI_API_KEY = key;
            GEMINI_MODEL = model;
            
            updateFabStates();
            toggleSettings();
            alert(`Settings Saved!\nModel: ${model}\nVoice & Vision Active.`);
        }

        function resetKey() {
            localStorage.removeItem('gemini_api_key');
            GEMINI_API_KEY = "";
            apiKeyInput.value = "";
            updateFabStates();
            alert("Key cleared. Using Browser Voice.");
        }
        
        function showFullError() {
            if (lastErrorDetail) {
                errorDetailText.textContent = lastErrorDetail;
                errorModal.classList.remove('hidden');
            }
        }
        
        // --- Toggle Stats Logic ---
        function toggleStats() {
            modalStats.classList.toggle('hidden');
            const icon = document.getElementById('statsToggleIcon');
            if (modalStats.classList.contains('hidden')) {
                icon.classList.remove('ph-caret-up');
                icon.classList.add('ph-caret-down');
            } else {
                icon.classList.remove('ph-caret-down');
                icon.classList.add('ph-caret-up');
            }
        }

        // --- Camera Logic ---
        fabCamera.addEventListener('click', () => {
            if (!GEMINI_API_KEY) {
                statusMsg.textContent = "Setup AI Key for Photo Search";
                statusMsg.className = "text-xs text-red-500 font-bold animate-pulse cursor-pointer";
                setTimeout(() => toggleSettings(), 800);
                return;
            }
            cameraInput.click();
        });

        cameraInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            fabCamera.classList.add('ai-processing');
            statusMsg.textContent = "Analyzing Image...";
            statusMsg.className = "text-xs font-bold text-purple-600 animate-pulse";

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onloadend = async () => {
                const base64data = reader.result.split(',')[1];
                let mimeType = reader.result.split(',')[0].match(/:(.*?);/)[1];
                await sendImageToGemini(base64data, mimeType);
                cameraInput.value = ''; 
                fabCamera.classList.remove('ai-processing');
            };
        });

        async function sendImageToGemini(base64data, mimeType) {
            const prompt = `
                Look at this image. If it is a Pokemon (or a drawing of one), identify it.
                Return ONLY valid JSON: {"name": "Pikachu"}.
                If you cannot identify it as a Pokemon, return {"name": "null", "reason": "Not a Pokemon"}.
            `;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: prompt },
                                { inlineData: { mimeType: mimeType, data: base64data } }
                            ]
                        }]
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    lastErrorDetail = JSON.stringify(data.error, null, 2);
                    statusMsg.innerHTML = `<span class="block">Vision Error</span><span class="block text-xs font-normal opacity-75">(Tap for Details)</span>`;
                    statusMsg.className = "text-sm text-red-700 font-bold cursor-pointer bg-red-100 p-2 rounded shadow-sm hover:bg-red-200 text-center select-none w-full border border-red-300";
                    return;
                }

                const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                let pokeName = null;
                try {
                    const jsonStr = text.match(/\{.*\}/s)?.[0];
                    if (jsonStr) {
                        const parsed = JSON.parse(jsonStr);
                        pokeName = parsed.name;
                    }
                } catch (e) {}

                if (pokeName && pokeName !== "null") {
                    statusMsg.textContent = `AI Found: "${pokeName}"`;
                    statusMsg.className = "text-xs text-green-600 font-bold";
                    searchInput.value = pokeName;
                    filterPokemon();
                } else {
                    statusMsg.textContent = "AI could not identify Pokemon.";
                    statusMsg.className = "text-xs text-red-500 italic";
                }

            } catch (error) {
                lastErrorDetail = error.message;
                statusMsg.innerHTML = `<span class="block">Network Error</span><span class="block text-xs font-normal opacity-75">(Tap for Details)</span>`;
                statusMsg.className = "text-sm text-red-700 font-bold cursor-pointer bg-red-100 p-2 rounded shadow-sm hover:bg-red-200 text-center select-none w-full border border-red-300";
            }
        }


        // --- Main Voice Handler ---
        fabMic.addEventListener('click', () => {
            if (GEMINI_API_KEY) {
                handleAIVoice();
            } else {
                handleBrowserVoice();
            }
        });

        // --- 1. Browser Voice Logic (Fallback) ---
        function handleBrowserVoice() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                alert("Browser voice not supported. Please use Chrome or add an API Key.");
                return;
            }

            if (fabMic.classList.contains('browser-listening')) {
                if (browserRecognition) browserRecognition.stop();
                return;
            }

            if (!browserRecognition) {
                browserRecognition = new SpeechRecognition();
                browserRecognition.lang = 'en-US';
                browserRecognition.interimResults = false;
                
                browserRecognition.onstart = () => {
                    fabMic.classList.add('browser-listening');
                    statusMsg.textContent = "Listening (Basic)...";
                    statusMsg.className = "text-xs font-bold text-red-600 animate-pulse";
                };

                browserRecognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    performFuzzySearch(transcript);
                };

                browserRecognition.onend = () => resetMicState();
                
                browserRecognition.onerror = (event) => {
                    if (event.error === 'aborted') return;
                    statusMsg.textContent = "Error. Try again.";
                    resetMicState();
                };
            }

            try { browserRecognition.start(); } catch(e) { }
        }

        // --- 2. AI Voice Logic (Gemini) ---
        async function handleAIVoice() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert("Microphone access denied or not supported.");
                return;
            }

            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                return;
            }

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data && event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstart = () => {
                    fabMic.classList.add('ai-listening');
                    statusMsg.textContent = "Listening (AI)... Tap mic to stop.";
                    statusMsg.className = "text-xs font-bold text-blue-600 animate-pulse";
                };

                mediaRecorder.onstop = async () => {
                    fabMic.classList.remove('ai-listening');
                    fabMic.classList.add('ai-processing');
                    statusMsg.textContent = "AI Thinking...";
                    statusMsg.className = "text-xs font-bold text-purple-600 animate-pulse";

                    const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType });
                    
                    if (audioBlob.size < 500) {
                        statusMsg.textContent = "Audio too short/empty. Try again.";
                        statusMsg.className = "text-xs text-red-500 font-bold";
                        resetMicState();
                        stream.getTracks().forEach(track => track.stop());
                        return;
                    }

                    await sendAudioToGemini(audioBlob);
                    
                    fabMic.classList.remove('ai-processing');
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();

                setTimeout(() => {
                    if (mediaRecorder && mediaRecorder.state === "recording") {
                        mediaRecorder.stop();
                    }
                }, 5000);

            } catch (err) {
                statusMsg.textContent = "Mic Error. Check permissions.";
                resetMicState();
            }
        }

        async function sendAudioToGemini(blob) {
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = async () => {
                const base64data = reader.result.split(',')[1];
                let mimeType = reader.result.split(',')[0].match(/:(.*?);/)[1];
                if (mimeType.includes(';')) {
                    mimeType = mimeType.split(';')[0];
                }

                const prompt = `
                    You are a Pokedex. Listen to this audio. The user is saying a Pokémon name.
                    1. Identify the Pokemon name (e.g. "Charmander", "Pikachu").
                    2. If they describe it (e.g. "fire lizard"), identify the most likely Pokemon.
                    3. Return ONLY valid JSON: {"name": "Pikachu"}.
                    4. If you cannot hear anything or it is not a Pokemon, return {"name": "null", "reason": "unclear"}.
                `;

                const url = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;
                
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{
                                parts: [
                                    { text: prompt },
                                    { inlineData: { mimeType: mimeType, data: base64data } }
                                ]
                            }]
                        })
                    });

                    const data = await response.json();
                    
                    if (data.error) {
                        lastErrorDetail = JSON.stringify(data.error, null, 2);
                        let shortMsg = "Error: " + data.error.message;
                        if (shortMsg.length > 25) shortMsg = shortMsg.substring(0, 25) + "...";
                        
                        statusMsg.innerHTML = `<span class="block">${shortMsg}</span><span class="block text-xs font-normal opacity-75">(Tap for Details)</span>`;
                        statusMsg.className = "text-sm text-red-700 font-bold cursor-pointer bg-red-100 p-2 rounded shadow-sm hover:bg-red-200 text-center select-none w-full border border-red-300";
                        return;
                    }

                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    let pokeName = null;
                    try {
                        const jsonStr = text.match(/\{.*\}/s)?.[0];
                        if (jsonStr) {
                            const parsed = JSON.parse(jsonStr);
                            pokeName = parsed.name;
                            reason = parsed.reason;
                        }
                    } catch (e) { }

                    if (pokeName && pokeName !== "null") {
                        statusMsg.textContent = `AI Heard: "${pokeName}"`;
                        statusMsg.className = "text-xs text-green-600 font-bold";
                        searchInput.value = pokeName;
                        filterPokemon();
                    } else {
                        statusMsg.textContent = "AI didn't understand (" + (reason || "Unknown") + ")";
                        statusMsg.className = "text-xs text-red-500 italic";
                    }

                } catch (error) {
                    lastErrorDetail = error.message;
                    statusMsg.innerHTML = `<span class="block">Network Error</span><span class="block text-xs font-normal opacity-75">(Tap for Details)</span>`;
                    statusMsg.className = "text-sm text-red-700 font-bold cursor-pointer bg-red-100 p-2 rounded shadow-sm hover:bg-red-200 text-center select-none w-full border border-red-300";
                }
            };
        }

        function resetMicState() {
            fabMic.classList.remove('browser-listening', 'ai-listening', 'ai-processing');
            if (mediaRecorder && mediaRecorder.state === "recording") mediaRecorder.stop();
            if (browserRecognition) browserRecognition.stop();
        }

        function performFuzzySearch(transcript) {
            const target = transcript.toLowerCase().replace(/[^a-z0-9]/g, ''); 
            let bestMatch = null;
            let minDistance = Infinity;

            for (const poke of allPokemon) {
                const pokeName = poke.name.replace('-', '');
                const dist = levenshtein(target, pokeName);
                if (dist === 0) { bestMatch = poke.name; minDistance = 0; break; }
                if (dist < minDistance) { minDistance = dist; bestMatch = poke.name; }
            }
            
            const threshold = Math.max(3, Math.floor(target.length * 0.4));
            if (minDistance <= threshold) {
                searchInput.value = bestMatch;
                statusMsg.textContent = `Heard "${transcript}", Found "${bestMatch}"`;
                statusMsg.className = "text-xs text-green-600 font-bold";
            } else {
                searchInput.value = transcript;
                statusMsg.textContent = `Heard "${transcript}" (No match)`;
                statusMsg.className = "text-xs text-gray-500 italic";
            }
            filterPokemon();
        }

        function levenshtein(a, b) {
            const matrix = [];
            for (let i = 0; i <= b.length; i++) matrix[i] = [i];
            for (let j = 0; j <= a.length; j++) matrix[0][j] = j;
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(matrix[i - 1][j - 1] + 1, Math.min(matrix[i][j - 1] + 1, matrix[i - 1][j] + 1));
                    }
                }
            }
            return matrix[b.length][a.length];
        }

        function getGeneration(id) {
            for (const [gen, range] of Object.entries(GENERATIONS)) if (id >= range.start && id <= range.end) return parseInt(gen);
            return 9;
        }
        function formatId(id) { return '#' + id.toString().padStart(4, '0'); }
        function formatName(name) { return name.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' '); }

        function renderPokemon(pokemonList) {
            grid.innerHTML = '';
            if (pokemonList.length === 0) {
                noResults.classList.remove('hidden');
                countDisplay.textContent = `Showing 0 Pokémon`;
                return;
            }
            noResults.classList.add('hidden');
            countDisplay.textContent = `Showing ${pokemonList.length} Pokémon`;
            
            const batchSize = 50;
            const fragment = document.createDocumentFragment();
            pokemonList.slice(0, batchSize).forEach(poke => fragment.appendChild(createCard(poke)));
            grid.appendChild(fragment);
            if (pokemonList.length > batchSize) {
                setTimeout(() => {
                    const remaining = document.createDocumentFragment();
                    pokemonList.slice(batchSize).forEach(poke => remaining.appendChild(createCard(poke)));
                    grid.appendChild(remaining);
                }, 100);
            }
        }

        function createCard(poke) {
            const card = document.createElement('div');
            card.className = 'poke-card bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden cursor-pointer flex flex-col';
            card.onclick = () => openModal(poke);
            card.innerHTML = `
                <div class="bg-gray-50 p-6 flex items-center justify-center relative">
                    <span class="absolute top-2 left-3 text-xs font-bold text-gray-400 font-mono tracking-wider">${poke.displayId}</span>
                    <img src="${poke.image}" alt="${poke.displayName}" loading="lazy" class="w-32 h-32 object-contain transform transition-transform duration-300 hover:scale-110" onerror="this.src='https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${poke.id}.png'">
                </div>
                <div class="p-3 text-center"><h3 class="text-gray-800 font-semibold text-sm sm:text-base truncate">${poke.displayName}</h3></div>
            `;
            return card;
        }

        function filterPokemon() {
            const genValue = genFilter.value;
            const searchValue = searchInput.value.toLowerCase().trim();
            const filtered = allPokemon.filter(poke => {
                const matchesGen = genValue === 'all' || poke.generation === parseInt(genValue);
                const matchesSearch = poke.displayName.toLowerCase().includes(searchValue) || poke.name.toLowerCase().includes(searchValue) || poke.id.toString() === searchValue;
                return matchesGen && matchesSearch;
            });
            renderPokemon(filtered);
        }

        function clearFilters() {
            searchInput.value = '';
            genFilter.value = 'all';
            resetMicState();
            filterPokemon();
            statusMsg.textContent = "Data: PokeAPI";
            statusMsg.className = "text-xs text-gray-500 italic";
            statusMsg.onclick = null; 
            lastErrorDetail = ""; 
            searchInput.focus(); 
        }

        genFilter.addEventListener('change', filterPokemon);
        searchInput.addEventListener('input', filterPokemon);
        clearBtn.addEventListener('click', clearFilters);

        // --- Modal ---
        async function openModal(poke) {
            document.getElementById('modalImg').src = poke.image;
            document.getElementById('modalName').textContent = poke.displayName;
            document.getElementById('modalId').textContent = poke.displayId;
            document.getElementById('modalGen').textContent = poke.generation;
            document.getElementById('wikiLink').href = `https://bulbapedia.bulbagarden.net/wiki/${poke.displayName.replace(' ', '_')}_(Pok%C3%A9mon)`;
            modal.classList.remove('hidden');
            setTimeout(() => { modalContent.classList.remove('scale-95'); modalContent.classList.add('scale-100'); }, 10);
            
            // Clear previous
            evoContainer.innerHTML = '';
            gamesContainer.innerHTML = '<span class="italic text-gray-400">Loading...</span>';
            modalTypes.innerHTML = ''; // Clear types
            weaknessContainer.innerHTML = ''; // Clear weaknesses
            modalStats.innerHTML = ''; // Clear stats
            roleContainer.innerHTML = ''; // Clear roles
            evoLoading.classList.remove('hidden');

            try {
                const mainRes = await fetch(`https://pokeapi.co/api/v2/pokemon/${poke.id}/`);
                const mainData = await mainRes.json();
                
                const speciesRes = await fetch(mainData.species.url);
                const speciesData = await speciesRes.json();
                
                const evoRes = await fetch(speciesData.evolution_chain.url);
                const evoData = await evoRes.json();
                
                // 1. Render Types
                if(mainData.types) {
                    mainData.types.forEach(t => {
                        const pill = document.createElement('span');
                        pill.className = `type-pill type-${t.type.name}`;
                        pill.textContent = t.type.name;
                        modalTypes.appendChild(pill);
                    });

                    // 2. Render Weaknesses (Based on types)
                    const { weak2x, weak4x } = calculateWeaknesses(mainData.types);
                    
                    if (weak4x.length > 0 || weak2x.length > 0) {
                        let wHtml = '';
                        if (weak4x.length > 0) {
                            wHtml += `<div class="mb-2"><span class="text-xs font-bold text-red-600 block mb-1 uppercase tracking-wide">Extreme Threat (4x)</span><div class="flex flex-wrap justify-center md:justify-start gap-1">`;
                            weak4x.forEach(t => wHtml += `<span class="info-badge type-${t}">${t}</span>`);
                            wHtml += `</div></div>`;
                        }
                        if (weak2x.length > 0) {
                            wHtml += `<div><span class="text-xs font-bold text-gray-500 block mb-1 uppercase tracking-wide">Weakness (2x)</span><div class="flex flex-wrap justify-center md:justify-start gap-1">`;
                            weak2x.forEach(t => wHtml += `<span class="info-badge type-${t}">${t}</span>`);
                            wHtml += `</div></div>`;
                        }
                        weaknessContainer.innerHTML = wHtml;
                    } else {
                        weaknessContainer.innerHTML = `<span class="text-xs text-gray-400 italic">No weaknesses found (possibly unknown types).</span>`;
                    }
                }
                
                // 3. Render Base Stats
                if (mainData.stats) {
                    const stats = mainData.stats;
                    const statMap = {};
                    stats.forEach(s => statMap[s.stat.name] = s.base_stat);

                    const orderedStats = ['hp', 'speed', 'attack', 'special-attack', 'defense', 'special-defense'];
                    // Updated to full names
                    const statLabels = { 
                        'hp': 'HP', 
                        'speed': 'Speed', 
                        'attack': 'Attack', 
                        'special-attack': 'Special Attack', 
                        'defense': 'Defense', 
                        'special-defense': 'Special Defense' 
                    };
                    const statColors = { 'hp': 'stat-bar-hp', 'speed': 'stat-bar-spe', 'attack': 'stat-bar-atk', 'special-attack': 'stat-bar-spa', 'defense': 'stat-bar-def', 'special-defense': 'stat-bar-spd' };
                    
                    // Render Bars
                    // Note: We iterate through orderedStats to ensure correct layout order (HP|Spe, Atk|SpA, Def|SpD)
                    orderedStats.forEach(key => {
                         const val = statMap[key];
                         const maxStat = 255;
                         const width = Math.min((val / maxStat) * 100, 100);
                         const bar = document.createElement('div');
                         bar.className = 'col-span-1 mb-1';
                         bar.innerHTML = `
                            <div class="flex justify-between mb-0.5">
                                <span class="font-semibold">${statLabels[key]}</span>
                                <span class="font-bold text-gray-800">${val}</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-1.5">
                                <div class="${statColors[key]} h-1.5 rounded-full" style="width: ${width}%"></div>
                            </div>
                         `;
                         modalStats.appendChild(bar);
                    });
                    
                    // Determine Role
                    const atk = statMap['attack'];
                    const spa = statMap['special-attack'];
                    const def = statMap['defense'];
                    const spd = statMap['special-defense'];
                    
                    let attackRole = "";
                    let attackIcon = "";
                    // Use ph-sword (singular) for all Attack roles (Swapped from ph-swords)
                    if (atk > spa * 1.2) { attackRole = "Physical Attacker"; attackIcon = "ph-sword"; }
                    else if (spa > atk * 1.2) { attackRole = "Special Attacker"; attackIcon = "ph-sword"; }
                    else { attackRole = "Mixed Attacker"; attackIcon = "ph-sword"; }

                    let defenseRole = "";
                    let defenseIcon = "";
                    // Use ph-shield for all Defense roles
                    if (def > spd * 1.2) { defenseRole = "Physical Wall"; defenseIcon = "ph-shield"; }
                    else if (spd > def * 1.2) { defenseRole = "Special Wall"; defenseIcon = "ph-shield"; }
                    else { defenseRole = "Mixed Defender"; defenseIcon = "ph-shield"; }
                    
                    roleContainer.innerHTML = `
                        <span class="info-badge info-badge-neutral flex items-center gap-1 w-max"><i class="ph ${attackIcon} text-sm"></i>${attackRole}</span>
                        <span class="info-badge info-badge-neutral flex items-center gap-1 w-max"><i class="ph ${defenseIcon} text-sm"></i>${defenseRole}</span>
                    `;
                }

                // 4. Render Evolution
                evoLoading.classList.add('hidden');
                renderEvolutionChain(evoData.chain, poke.displayName);

                // 5. Render Games
                if (speciesData.flavor_text_entries && speciesData.flavor_text_entries.length > 0) {
                    gamesContainer.innerHTML = '';
                    const uniqueVersions = new Set();
                    speciesData.flavor_text_entries.forEach(entry => {
                        if (entry.language.name === 'en') {
                            uniqueVersions.add(entry.version.name);
                        }
                    });

                    if(uniqueVersions.size > 0) {
                        uniqueVersions.forEach(ver => {
                            const tag = document.createElement('span');
                            let colorClass = 'tag-default';
                            if(ver.includes('red') || ver.includes('ruby')) colorClass = 'tag-red';
                            else if(ver.includes('blue') || ver.includes('sapphire')) colorClass = 'tag-blue';
                            else if(ver.includes('yellow')) colorClass = 'tag-yellow';
                            else if(ver.includes('gold') || ver.includes('sun')) colorClass = 'tag-gold';
                            else if(ver.includes('silver') || ver.includes('moon')) colorClass = 'tag-silver';
                            else if(ver.includes('crystal') || ver.includes('diamond')) colorClass = 'tag-crystal';
                            else if(ver.includes('emerald')) colorClass = 'tag-emerald';
                            else if(ver.includes('pearl')) colorClass = 'tag-pearl';
                            else if(ver.includes('platinum')) colorClass = 'tag-platinum';
                            else if(ver.includes('black')) colorClass = 'tag-black';
                            else if(ver.includes('white')) colorClass = 'tag-white';
                            else if(ver.includes('sword')) colorClass = 'tag-sword';
                            else if(ver.includes('shield')) colorClass = 'tag-shield';
                            else if(ver.includes('x')) colorClass = 'tag-x';
                            else if(ver.includes('y')) colorClass = 'tag-y';
                            else if(ver.includes('scarlet')) colorClass = 'tag-scarlet';
                            else if(ver.includes('violet')) colorClass = 'tag-violet';
                            else if(ver.includes('legends') || ver.includes('arceus')) colorClass = 'tag-legends-arceus';

                            tag.className = `game-tag ${colorClass}`;
                            tag.textContent = ver.replace(/-/g, ' ');
                            gamesContainer.appendChild(tag);
                        });
                    } else {
                         gamesContainer.innerHTML = '<span class="italic text-gray-400">No game data found.</span>';
                    }
                } else {
                    gamesContainer.innerHTML = '<span class="italic text-gray-400">No game data found.</span>';
                }

            } catch (err) { 
                console.error(err); // Debug
                evoLoading.classList.add('hidden'); 
                evoContainer.innerHTML = '<p class="text-gray-400 text-sm italic">Data unavailable.</p>'; 
                gamesContainer.innerHTML = '<p class="text-gray-400 text-sm italic">Game data unavailable.</p>'; 
            }
        }

        function renderEvolutionChain(chainNode, currentNameContext) {
            const tiers = {};
            const processNode = (node, depth) => {
                if (!tiers[depth]) tiers[depth] = [];
                tiers[depth].push(node);
                if (node.evolves_to) node.evolves_to.forEach(child => processNode(child, depth + 1));
            };
            processNode(chainNode, 0);
            evoContainer.innerHTML = ''; 
            
            let regionContext = "";
            if (currentNameContext) {
                if (currentNameContext.includes("Alolan")) regionContext = "Alolan";
                if (currentNameContext.includes("Galarian")) regionContext = "Galarian";
                if (currentNameContext.includes("Hisuian")) regionContext = "Hisuian";
                if (currentNameContext.includes("Paldean")) regionContext = "Paldean";
            }

            Object.keys(tiers).forEach((depth) => {
                const depthInt = parseInt(depth);
                
                const filteredNodes = tiers[depth].filter(node => shouldKeepNode(node, regionContext));
                
                if (filteredNodes.length > 0) {
                    if (depthInt > 0) {
                         const arrow = document.createElement('div');
                         arrow.className = "text-red-300 mx-0.5 sm:mx-2";
                         arrow.innerHTML = `<svg class="w-4 h-4 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path></svg>`;
                         evoContainer.appendChild(arrow);
                    }
                    const tierDiv = document.createElement('div');
                    tierDiv.className = "flex flex-wrap justify-center gap-2";
                    filteredNodes.forEach(node => tierDiv.appendChild(createEvoNode(node, regionContext)));
                    evoContainer.appendChild(tierDiv);
                }
            });
        }
        
        function shouldKeepNode(node, regionContext) {
            const speciesName = node.species.name;
            if (REGIONAL_EVOLUTIONS[speciesName]) {
                return REGIONAL_EVOLUTIONS[speciesName] === regionContext;
            }
            if (STANDARD_EVOLUTIONS_TO_BLOCK_IF_REGIONAL.includes(speciesName)) {
                if (regionContext === 'Galarian' && (speciesName === 'persian' || speciesName === 'cofagrigus' || speciesName === 'linoone' || speciesName === 'mr-mime' || speciesName === 'weezing')) return false;
                if (regionContext === 'Alolan' && (speciesName === 'raichu' || speciesName === 'marowak' || speciesName === 'exeggutor')) return false;
            }
            return true;
        }
        
        function createEvoNode(node, regionContext) {
            let name = cleanName(node.species.name);
            let formattedName = formatName(name);
            let id = node.species.url.split('/')[6]; 
            
            if (regionContext) {
                const variantNameAttempt = `${regionContext} ${formattedName}`;
                const variantMatch = allPokemon.find(p => p.displayName === variantNameAttempt);
                if (variantMatch) {
                    id = variantMatch.id; 
                    formattedName = variantMatch.displayName;
                }
            }

            const imgUrl = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png`;

            let evoReq = "";
            if (node.evolution_details && node.evolution_details.length > 0) {
                evoReq = formatEvolutionCondition(node.evolution_details[0]);
            }
            
            const pokeDiv = document.createElement('div');
            pokeDiv.className = "relative flex flex-col items-center p-2 hover:bg-gray-50 rounded-lg transition-colors cursor-pointer group mt-3"; 
            
            pokeDiv.onclick = (e) => {
                e.stopPropagation(); 
                const targetPoke = allPokemon.find(p => p.displayName === formattedName); 
                if (targetPoke) {
                    searchInput.value = formattedName;
                    filterPokemon(); 
                    openModal(targetPoke); 
                } else {
                    const basePoke = allPokemon.find(p => p.name.toLowerCase() === node.species.name.toLowerCase());
                     if (basePoke) {
                        openModal(basePoke);
                     }
                }
            };
            
            const badgeHTML = evoReq ? `<span class="absolute -top-2 left-1/2 transform -translate-x-1/2 text-[9px] text-gray-500 font-medium bg-white px-2 py-0.5 rounded-full shadow-sm border border-gray-100 whitespace-nowrap z-10">${evoReq}</span>` : '';

            pokeDiv.innerHTML = `
                ${badgeHTML}
                <div class="w-14 h-14 sm:w-20 sm:h-20 bg-gray-100 rounded-full flex items-center justify-center mb-1 sm:mb-2 shadow-sm border border-gray-200 group-hover:border-red-200"><img src="${imgUrl}" class="w-10 h-10 sm:w-16 sm:h-16 object-contain"></div>
                <span class="text-[10px] sm:text-xs font-bold text-gray-700 text-center leading-tight max-w-[60px] sm:max-w-none truncate">${formattedName}</span>
            `;
            return pokeDiv;
        }

        // Helper to format conditions
        function formatEvolutionCondition(detail) {
            if (!detail) return '';
            const triggers = [];
            
            if (detail.min_level) triggers.push(`Lvl ${detail.min_level}`);
            if (detail.min_happiness) triggers.push('Friendship');
            if (detail.min_beauty) triggers.push('Beauty');
            if (detail.item) triggers.push(formatName(cleanName(detail.item.name)));
            if (detail.trigger.name === 'trade') triggers.push('Trade');
            if (detail.held_item) triggers.push(`Hold ${formatName(cleanName(detail.held_item.name))}`);
            if (detail.known_move) triggers.push(`Knows ${formatName(cleanName(detail.known_move.name))}`);
            if (detail.known_move_type) triggers.push(`Knows ${formatName(detail.known_move_type.name)} Type`);
            if (detail.location) triggers.push(`at ${formatName(cleanName(detail.location.name))}`);
            if (detail.time_of_day) triggers.push(`(${detail.time_of_day})`);
            if (detail.rain) triggers.push('(Rain)');
            
            if (triggers.length === 0) return ''; 
            return triggers.slice(0, 2).join(' + ');
        }

        function closeModalFunc() { modalContent.classList.remove('scale-100'); modalContent.classList.add('scale-95'); setTimeout(() => { modal.classList.add('hidden'); evoContainer.innerHTML = ''; }, 200); }
        closeModal.addEventListener('click', closeModalFunc);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModalFunc(); });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (!modal.classList.contains('hidden')) {
                    closeModalFunc();
                }
                const settingsModal = document.getElementById('settingsModal');
                if (!settingsModal.classList.contains('hidden')) {
                    toggleSettings();
                }
                const errorModal = document.getElementById('errorModal');
                if (!errorModal.classList.contains('hidden')) {
                    errorModal.classList.add('hidden');
                }
            }
        });
        
        // --- Toggle Stats Logic ---
        function toggleStats() {
            modalStats.classList.toggle('hidden');
            const icon = document.getElementById('statsToggleIcon');
            if (modalStats.classList.contains('hidden')) {
                icon.classList.remove('ph-caret-up');
                icon.classList.add('ph-caret-down');
            } else {
                icon.classList.remove('ph-caret-down');
                icon.classList.add('ph-caret-up');
            }
        }
    </script>
</body>
</html>
